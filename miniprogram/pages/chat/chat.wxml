<view class="chat-container {{isDarkMode ? 'dark-mode' : ''}}">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="chat-header">
    <view class="header-left">
      <button class="back-btn" bindtap="navigateBack">
        <text class="icon-back">â€¹</text>
      </button>
    </view>
    <view class="header-center">
      <view class="user-info">
        <text class="user-nickname">{{targetUser.nickname || 'åŒ¿åç”¨æˆ·'}}</text>
        <text class="user-status" wx:if="{{targetUser.distance !== undefined}}">è·ç¦»{{targetUser.distance}}m</text>
      </view>
    </view>
    <view class="header-right">
      <button class="header-btn" bindtap="toggleDarkMode">
        <text class="icon">{{isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™'}}</text>
      </button>
      <button class="header-btn" bindtap="showReportModal">
        <text class="icon">â‹¯</text>
      </button>
    </view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view class="messages-list" scroll-y="true" scroll-into-view="{{scrollIntoView}}" bindscrolltoupper="onScrollToUpper">
    <!-- åŠ è½½æ›´å¤šæç¤º -->
    <view class="load-more-tip" wx:if="{{hasMoreMessages && !isLoadingMore}}">
      <text>ä¸‹æ‹‰åŠ è½½æ›´å¤šæ¶ˆæ¯</text>
    </view>
    <view class="load-more-tip" wx:if="{{isLoadingMore}}">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- æ¶ˆæ¯é¡¹ -->
    <block wx:for="{{messages}}" wx:key="id">
      <!-- æ—¶é—´åˆ†éš” -->
      <view class="time-divider" wx:if="{{item.showTime}}">
        <text>{{item.displayTime}}</text>
      </view>
      
      <!-- æ¶ˆæ¯æ°”æ³¡ -->
      <view class="message-wrapper {{item.senderId === app.globalData.user.openid ? 'sent' : 'received'}}" id="msg-{{item.id}}" bindlongpress="onMessageLongPress" data-message="{{item}}" data-index="{{index}}">
        <!-- æ¥æ”¶æ¶ˆæ¯ï¼šå¤´åƒåœ¨å·¦ -->
        <image wx:if="{{item.senderId !== app.globalData.user.openid}}" class="avatar" src="{{targetUser.avatarSrc || '/images/mock_avatar.png'}}" mode="aspectFill"></image>
        
        <view class="message-content">
          <!-- å¼•ç”¨æ¶ˆæ¯ -->
          <view class="quoted-msg" wx:if="{{item.quotedMessage}}">
            <text>{{item.quotedMessage.content}}</text>
          </view>
          
          <!-- æ¶ˆæ¯ä¸»ä½“ -->
          <view class="message-bubble {{item.senderId === app.globalData.user.openid ? 'bubble-sent' : 'bubble-received'}}">
            <!-- æ–‡æœ¬æ¶ˆæ¯ -->
            <text wx:if="{{item.type === 'text'}}" class="message-text">{{item.content}}</text>
            
            <!-- è¯­éŸ³æ¶ˆæ¯ -->
            <view wx:if="{{item.type === 'voice'}}" class="voice-msg" bindtap="playVoice" data-url="{{item.voiceUrl}}" data-id="{{item.id}}">
              <text class="voice-icon">{{item.isPlaying ? 'â¸ï¸' : 'ğŸµ'}}</text>
              <view class="voice-waves" wx:if="{{item.isPlaying}}">
                <view class="wave"></view>
                <view class="wave"></view>
                <view class="wave"></view>
              </view>
              <text class="voice-duration">{{item.duration}}"</text>
            </view>
          </view>
          
          <!-- æ¶ˆæ¯çŠ¶æ€ï¼ˆä»…å‘é€çš„æ¶ˆæ¯æ˜¾ç¤ºï¼‰ -->
          <view wx:if="{{item.senderId === app.globalData.user.openid}}" class="message-status">
            <text class="status-text">{{item.statusText}}</text>
            <text class="status-icon {{item.status}}">{{item.statusIcon}}</text>
          </view>
        </view>
        
        <!-- å‘é€æ¶ˆæ¯ï¼šå¤´åƒåœ¨å³ -->
        <image wx:if="{{item.senderId === app.globalData.user.openid}}" class="avatar" src="{{currentUserAvatarSrc || '/images/mock_avatar.png'}}" mode="aspectFill"></image>
      </view>
    </block>

    <!-- è¶…å‡ºèŒƒå›´æç¤º -->
    <view class="range-warning" wx:if="{{!inRange}}">
      <text class="warning-icon">âš ï¸</text>
      <text class="warning-text">æ‚¨å·²è¶…å‡ºèŠå¤©èŒƒå›´</text>
    </view>
  </scroll-view>

  <!-- å¼•ç”¨å›å¤æ¡ -->
  <view class="reply-bar" wx:if="{{showReplyPanel && replyingTo}}">
    <view class="reply-line"></view>
    <view class="reply-info">
      <text class="reply-label">å›å¤</text>
      <text class="reply-content">{{replyingTo.content}}</text>
    </view>
    <button class="reply-close" bindtap="cancelReply">
      <text>âœ•</text>
    </button>
  </view>

  <!-- åº•éƒ¨è¾“å…¥æ ï¼ˆå¾®ä¿¡é£æ ¼ï¼‰ -->
  <view class="input-bar">
    <!-- å·¦ä¾§åŠŸèƒ½æŒ‰é’® -->
    <view class="input-left">
      <button class="func-btn voice-btn {{isRecording ? 'recording' : ''}}" bindtouchstart="startRecord" bindtouchend="stopRecord" bindtouchcancel="cancelRecord" disabled="{{!inRange}}">
        <text class="btn-icon">ğŸ¤</text>
      </button>
    </view>
    
    <!-- ä¸­é—´è¾“å…¥æ¡† -->
    <view class="input-center">
      <view class="input-wrapper">
        <textarea class="text-input" placeholder="{{inRange ? 'è¾“å…¥æ¶ˆæ¯' : 'è¶…å‡ºèŒƒå›´'}}" value="{{inputContent}}" bindinput="onInputChange" disabled="{{!inRange || isSending}}" auto-height maxlength="500" show-confirm-bar="{{false}}"></textarea>
        
        <!-- å½•éŸ³çŠ¶æ€ -->
        <view class="recording-status" wx:if="{{isRecording}}">
          <view class="recording-dot"></view>
          <text class="recording-text">å½•éŸ³ä¸­ {{recordDuration}}s</text>
          <text class="recording-tip">æ¾å¼€å‘é€ï¼Œä¸Šæ»‘å–æ¶ˆ</text>
        </view>
      </view>
    </view>
    
    <!-- å³ä¾§å‘é€æŒ‰é’® -->
    <view class="input-right">
      <!-- å½“æœ‰è¾“å…¥å†…å®¹æ—¶æ˜¾ç¤ºå‘é€æŒ‰é’® -->
      <button wx:if="{{hasInputContent}}" class="send-btn" bindtap="sendMessage" disabled="{{!inRange || isSending}}">
        <text class="send-text">{{isSending ? 'å‘é€ä¸­' : 'å‘é€'}}</text>
      </button>
      
      <!-- æ— è¾“å…¥å†…å®¹æ—¶æ˜¾ç¤ºæ›´å¤šåŠŸèƒ½æŒ‰é’® -->
      <button wx:else class="func-btn more-btn" bindtap="showMoreOptions" disabled="{{!inRange}}">
        <text class="btn-icon">+</text>
      </button>
    </view>
  </view>

  <!-- æ›´å¤šåŠŸèƒ½é¢æ¿ -->
  <view class="more-panel" wx:if="{{showMorePanel}}">
    <view class="more-options">
      <button class="option-btn" bindtap="selectImage">
        <text class="option-icon">ğŸ“·</text>
        <text class="option-text">ç…§ç‰‡</text>
      </button>
      <button class="option-btn" bindtap="selectLocation">
        <text class="option-icon">ğŸ“</text>
        <text class="option-text">ä½ç½®</text>
      </button>
      <button class="option-btn" bindtap="selectFile">
        <text class="option-icon">ğŸ“</text>
        <text class="option-text">æ–‡ä»¶</text>
      </button>
    </view>
  </view>

  <!-- ä¸¾æŠ¥å¼¹çª— -->
  <modal title="ä¸¾æŠ¥ç”¨æˆ·" show="{{reportModalVisible}}" bind:confirm="submitReport" bind:cancel="closeReportModal">
    <view slot="content">
      <text>è¯·é€‰æ‹©ä¸¾æŠ¥åŸå› </text>
    </view>
  </modal>
</view>

<!-- æŸ¥æ‰¾ç±»ä¼¼è¿™æ ·çš„ä»£ç å¹¶ä¿®å¤ -->
<view class="header-info">
  <view class="user-avatar">
    <!-- ä¿®å¤å‰ï¼šå¯èƒ½æ˜¯é”™è¯¯çš„è·¯å¾„ -->
    <!-- <image src="/pages/chat/#4ECDC4" class="avatar-img"></image> -->
    
    <!-- ä¿®å¤åï¼šä½¿ç”¨æ­£ç¡®çš„å¤´åƒè·¯å¾„æˆ–é»˜è®¤å¤´åƒ -->
    <image src="{{targetUser.avatar || '/images/mock_avatar.png'}}" class="avatar-img" mode="aspectFill"></image>
    
    <!-- æˆ–è€…ä½¿ç”¨æ–‡å­—å¤´åƒä½œä¸ºå¤‡é€‰ -->
    <view wx:if="{{!targetUser.avatar}}" class="avatar-circle">
      <text>{{targetUser.nickname ? targetUser.nickname.charAt(0) : 'U'}}</text>
    </view>
  </view>
</view>